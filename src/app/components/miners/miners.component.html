<div class="miners-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Gestión de Mineros</h1>
        <p *ngIf="authService.isMinero()">Tu información personal y sensores</p>
        <p *ngIf="!authService.isMinero()">Administra y monitorea todos los mineros</p>
      </div>
      <div class="header-right" *ngIf="canCreateMiner()">
        <button class="btn btn-primary" (click)="openCreateModal()">
          <i class="fas fa-plus"></i>
          Nuevo Minero
        </button>
      </div>
    </div>
  </header>

  <!-- Stats Cards -->
  <section class="stats-section" *ngIf="!authService.isMinero()">
    <div class="stats-grid">
      <div class="stat-card glass">
        <div class="stat-icon">
          <i class="fas fa-users"></i>
        </div>
        <div class="stat-content">
          <h3>{{ totalMiners }}</h3>
          <p>Total Mineros</p>
        </div>
      </div>
      
      <div class="stat-card glass">
        <div class="stat-icon active">
          <i class="fas fa-wifi"></i>
        </div>
        <div class="stat-content">
          <h3>{{ activeMiners }}</h3>
          <p>Activos</p>
        </div>
      </div>
      
      <div class="stat-card glass">
        <div class="stat-icon warning">
          <i class="fas fa-user-slash"></i>
        </div>
        <div class="stat-content">
          <h3>{{ inactiveMiners }}</h3>
          <p>Inactivos</p>
        </div>
      </div>
      
      <div class="stat-card glass">
        <div class="stat-icon">
          <i class="fas fa-birthday-cake"></i>
        </div>
        <div class="stat-content">
          <h3>{{ avgAge | number:'1.0-0' }}</h3>
          <p>Edad Promedio</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Filters Section -->
  <section class="filters-section" *ngIf="!authService.isMinero()">
    <div class="filters-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Buscar por nombre, correo o RFC..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
      </div>
      
      <div class="filter-options">
        <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option *ngFor="let option of getStatusOptions()" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        
        <button class="btn btn-secondary">
          <i class="fas fa-filter"></i>
          Filtros Avanzados
        </button>
      </div>
    </div>
  </section>

  <!-- Permission Error State -->
  <div class="permission-error" *ngIf="hasPermissionError">
    <div class="error-content">
      <i class="fas fa-lock"></i>
      <h3>Acceso Restringido</h3>
      <p>{{ permissionErrorMessage }}</p>
      <div class="error-actions">
        <button class="btn btn-primary" (click)="goBack()">
          <i class="fas fa-arrow-left"></i>
          Volver a Equipos
        </button>
      </div>
    </div>
  </div>

  <!-- Miners Grid -->
  <section class="miners-section" *ngIf="!hasPermissionError">
    <div class="section-header" *ngIf="!authService.isMinero()">
      <h2>Lista de Mineros</h2>
      <span class="results-count">{{ filteredMiners.length }} mineros encontrados</span>
    </div>
  
    <div class="miners-grid" *ngIf="filteredMiners.length > 0">
      <div class="miner-card glass" *ngFor="let miner of filteredMiners; let i = index">
        <div class="card-header">
          <div class="miner-info">
            <div class="miner-avatar">
              <span>{{ miner.photo || miner.fullName.charAt(0) }}</span>
            </div>
            <div class="miner-details">
              <h3>{{ miner.fullName }}</h3>
              <span class="miner-email">{{ miner.email }}</span>
              <span class="miner-rfc">{{ miner.rfc || 'RFC no especificado' }}</span>
            </div>
          </div>
        </div>
        
        <div class="card-body">
          <div class="miner-details-grid">
            <div class="detail-item">
              <span class="detail-label">Teléfono:</span>
              <span class="detail-value">{{ miner.phone || 'No especificado' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Fecha Nacimiento:</span>
              <span class="detail-value">{{ miner.birthDate ? (miner.birthDate | date:'dd/MM/yyyy') : 'No especificada' }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">Equipo:</span>
              <span class="detail-value">
                {{ miner.teamId ? 'Equipo ' + miner.teamId : 'Sin equipo asignado' }}
              </span>
            </div>
          </div>
          
          <div class="address-section">
            <h4>Dirección</h4>
            <p>{{ getFullAddress(miner) }}</p>
          </div>
        </div>
        
        <div class="card-actions">
          <button class="btn btn-primary" (click)="showDetail(miner)">
            <i class="fas fa-eye"></i>
            Ver Detalle
          </button>
          
          <button 
            class="btn btn-secondary" 
            *ngIf="canModifyMiner()"
            (click)="editMiner(miner)"
          >
            <i class="fas fa-edit"></i>
            Editar
          </button>
          
          <button 
            class="btn btn-danger" 
            *ngIf="canModifyMiner()"
            (click)="deleteMiner(miner)"
          >
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="filteredMiners.length === 0" style="padding: 2rem; text-align: center; color: #8892b0;">
      No hay mineros
    </div>
  </section>

  <!-- Create Miner Modal -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Registrar Nuevo Minero</h3>
        <button class="close-btn" (click)="closeCreateModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        @if (errorMessage) {
          <div class="error-message">{{ errorMessage }}</div>
        }
        <form (ngSubmit)="createMiner(createMinerForm)" #createMinerForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label for="fullName">Nombre Completo</label>
              <input 
                type="text" 
                id="fullName"
                [(ngModel)]="newMiner.fullName" 
                name="fullName"
                #fullNameCtrl="ngModel"
                pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$"
                placeholder="Nombre completo del minero"
                required minlength="3"
              >
               <small class="error" *ngIf="(createMinerForm.submitted || fullNameCtrl.touched || fullNameCtrl.dirty) && !((newMiner.fullName || '').trim().length >= 3)">El nombre es obligatorio (mín. 3)</small>
              <small class="error" *ngIf="(createMinerForm.submitted || fullNameCtrl.touched || fullNameCtrl.dirty) && fullNameCtrl.errors?.['pattern']">Solo letras y espacios</small>
            </div>
          </div>
          
           <div class="form-group">
            <label for="email">Correo Electrónico</label>
            <input 
              type="email" 
              id="email"
              [(ngModel)]="newMiner.email" 
              name="email"
              #emailCtrl="ngModel"
              placeholder="correo@ejemplo.com"
               required
            >
            <small class="error" *ngIf="(createMinerForm.submitted || emailCtrl.touched || emailCtrl.dirty) && (newMiner.email || '').length === 0">El correo es obligatorio</small>
            <small class="error" *ngIf="(createMinerForm.submitted || emailCtrl.touched || emailCtrl.dirty) && (newMiner.email || '').length > 0 && !isValidEmail(newMiner.email)">Correo inválido</small>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label for="birthDate">Fecha de Nacimiento</label>
              <input 
                type="date" 
                id="birthDate"
                [(ngModel)]="newMiner.birthDate" 
                name="birthDate"
               #birthDateCtrl="ngModel"
               required
               [max]="adultMaxISO"
              >
              <small class="error" *ngIf="(createMinerForm.submitted || birthDateCtrl.touched || birthDateCtrl.dirty) && birthDateCtrl.errors?.['required']">La fecha de nacimiento es obligatoria</small>
              <small class="error" *ngIf="(createMinerForm.submitted || birthDateCtrl.touched || birthDateCtrl.dirty) && isInvalidBirthDate(newMiner.birthDate)">La fecha de nacimiento debe ser anterior a hoy</small>
            </div>
            <div class="form-group">
              <label for="fechaContratacion">Fecha de Contratación</label>
              <input 
                type="date" 
                id="fechaContratacion"
                [(ngModel)]="newMiner.fechaContratacion" 
                name="fechaContratacion"
                #hireDateCtrl="ngModel"
                required
              >
              <small class="error" *ngIf="(createMinerForm.submitted || hireDateCtrl.touched || hireDateCtrl.dirty) && hireDateCtrl.errors?.['required']">La fecha de contratación es obligatoria</small>
            </div>
          </div>
          
          <div class="form-group">
            <label for="phone">Teléfono</label>
            <input 
              type="tel" 
              id="phone"
              [(ngModel)]="newMiner.phone" 
              name="phone"
              #phoneCtrl="ngModel"
              required minlength="10"
              placeholder="+52 55 1234 5678"
            >
            <small class="error" *ngIf="(createMinerForm.submitted || phoneCtrl.touched || phoneCtrl.dirty) && phoneCtrl.errors?.['required']">El teléfono es obligatorio</small>
            <small class="error" *ngIf="(createMinerForm.submitted || phoneCtrl.touched || phoneCtrl.dirty) && phoneCtrl.errors?.['minlength']">El teléfono debe tener al menos 10 dígitos</small>
          </div>
          
            <div class="form-group">
            <label for="rfc">RFC</label>
             <input 
              type="text" 
              id="rfc"
              [(ngModel)]="newMiner.rfc" 
              name="rfc"
               #rfcCtrl="ngModel"
              placeholder="RFC del minero"
               required minlength="12" maxlength="13"
            >
              <small class="error" *ngIf="(createMinerForm.submitted || rfcCtrl.touched || rfcCtrl.dirty) && (newMiner.rfc || '').trim().length === 0">El RFC es obligatorio</small>
              <small class="error" *ngIf="(createMinerForm.submitted || rfcCtrl.touched || rfcCtrl.dirty) && (newMiner.rfc || '').trim().length > 0 && (newMiner.rfc || '').trim().length < 12">El RFC debe tener al menos 12 caracteres</small>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label for="genero">Género</label>
              <select id="genero" name="genero" [(ngModel)]="newMiner.genero" #generoCtrl="ngModel" required>
                <option [ngValue]="undefined">No especificado</option>
                <option value="masculino">Masculino</option>
                <option value="femenino">Femenino</option>
              </select>
              <small class="error" *ngIf="(createMinerForm.submitted || generoCtrl.touched || generoCtrl.dirty) && generoCtrl.errors?.['required']">El género es obligatorio</small>
            </div>
            <div class="form-group">
              <label for="especialidadEnMineria">Especialidad en Minería</label>
              <input 
                type="text" 
                id="especialidadEnMineria"
                [(ngModel)]="newMiner.especialidadEnMineria" 
                name="especialidadEnMineria"
                #especialidadCtrl="ngModel"
                required minlength="3"
                placeholder="Ej. Perforación, Ventilación, Seguridad"
              >
              <small class="error" *ngIf="(createMinerForm.submitted || especialidadCtrl.touched || especialidadCtrl.dirty) && especialidadCtrl.errors?.['required']">La especialidad es obligatoria</small>
              <small class="error" *ngIf="(createMinerForm.submitted || especialidadCtrl.touched || especialidadCtrl.dirty) && especialidadCtrl.errors?.['minlength']">La especialidad debe tener al menos 3 caracteres</small>
            </div>
          </div>
          
          <div class="form-group">
            <label for="address">Dirección</label>
            <textarea 
              id="address"
              [(ngModel)]="newMiner.address" 
              name="address"
              #addressCtrl="ngModel"
              required
              placeholder="Dirección completa del minero"
              rows="3"
            ></textarea>
            <small class="error" *ngIf="(createMinerForm.submitted || addressCtrl.touched || addressCtrl.dirty) && addressCtrl.errors?.['required']">La dirección es obligatoria</small>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fas fa-save"></i>
              Registrar Minero
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Miner Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Minero</h3>
        <button class="close-btn" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="saveEditMiner(editMinerForm)" #editMinerForm="ngForm">
          <div class="form-row">
            <div class="form-group">
              <label for="editFullName">Nombre Completo</label>
              <input type="text" id="editFullName" [(ngModel)]="editMinerData.fullName" name="editFullName" #editFullNameCtrl="ngModel" pattern="^[A-Za-zÁÉÍÓÚáéíóúÑñ ]+$" required minlength="3">
              @if ((editMinerForm.submitted || editFullNameCtrl.touched || editFullNameCtrl.dirty) && editFullNameCtrl.errors?.['pattern']) {
                <div class="error-message">Solo letras y espacios</div>
              }
              @if ((editMinerForm.submitted || editFullNameCtrl.touched || editFullNameCtrl.dirty) && !((editMinerData.fullName || '').trim().length >= 3)) {
                <div class="error-message">El nombre es obligatorio (mín. 3)</div>
              }
            </div>
          </div>
           <div class="form-group">
            <label for="editEmail">Correo Electrónico</label>
            <input type="email" id="editEmail" [(ngModel)]="editMinerData.email" name="editEmail" #editEmailCtrl="ngModel" required>
            @if ((editMinerForm.submitted || editEmailCtrl.touched || editEmailCtrl.dirty) && editEmailCtrl.errors?.['required']) {
              <div class="error-message">El correo es obligatorio</div>
            }
            @if ((editMinerForm.submitted || editEmailCtrl.touched || editEmailCtrl.dirty) && (editMinerData.email || '').length > 0 && !isValidEmail(editMinerData.email)) {
              <div class="error-message">Correo inválido</div>
            }
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="editBirthDate">Fecha de Nacimiento</label>
              <input type="date" id="editBirthDate" [(ngModel)]="editMinerData.birthDate" name="editBirthDate" #editBirthDateCtrl="ngModel" required [max]="adultMaxISO">
              @if ((editMinerForm.submitted || editBirthDateCtrl.touched || editBirthDateCtrl.dirty) && editBirthDateCtrl.errors?.['required']) {
                <div class="error-message">La fecha de nacimiento es obligatoria</div>
              }
              @if ((editMinerForm.submitted || editBirthDateCtrl.touched || editBirthDateCtrl.dirty) && isInvalidBirthDate(editMinerData.birthDate)) {
                <div class="error-message">La fecha de nacimiento debe ser anterior a hoy</div>
              }
            </div>
          </div>
          <div class="form-group">
            <label for="editPhone">Teléfono</label>
            <input type="tel" id="editPhone" [(ngModel)]="editMinerData.phone" name="editPhone" #editPhoneCtrl="ngModel" required minlength="10">
            @if ((editMinerForm.submitted || editPhoneCtrl.touched || editPhoneCtrl.dirty) && editPhoneCtrl.errors?.['required']) {
              <div class="error-message">El teléfono es obligatorio</div>
            }
            @if ((editMinerForm.submitted || editPhoneCtrl.touched || editPhoneCtrl.dirty) && editPhoneCtrl.errors?.['minlength']) {
              <div class="error-message">El teléfono debe tener al menos 10 dígitos</div>
            }
          </div>
          <div class="form-group">
            <label for="editRfc">RFC</label>
            <input type="text" id="editRfc" [(ngModel)]="editMinerData.rfc" name="editRfc" #editRfcCtrl="ngModel" required minlength="10" maxlength="13">
            @if ((editMinerForm.submitted || editRfcCtrl.touched || editRfcCtrl.dirty) && editRfcCtrl.errors?.['required']) {
              <div class="error-message">El RFC es obligatorio</div>
            }
            @if ((editMinerForm.submitted || editRfcCtrl.touched || editRfcCtrl.dirty) && editRfcCtrl.errors?.['minlength']) {
              <div class="error-message">El RFC debe tener al menos 10 caracteres</div>
            }
          </div>
          <div class="form-group">
            <label for="editAddress">Dirección</label>
            <textarea id="editAddress" [(ngModel)]="editMinerData.address" name="editAddress" rows="3" #editAddressCtrl="ngModel" required></textarea>
            @if ((editMinerForm.submitted || editAddressCtrl.touched || editAddressCtrl.dirty) && editAddressCtrl.errors?.['required']) {
              <div class="error-message">La dirección es obligatoria</div>
            }
          </div>
          @if (errorMessage) {
            <div class="error-message">{{ errorMessage }}</div>
          }
          <div class="modal-actions">
             @if (editFormError) {
               <div class="error-message">{{ editFormError }}</div>
             }
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fas fa-save"></i>
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Miner Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle del Minero</h3>
        <button class="close-btn" (click)="closeDetailModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="detail-row"><strong>Nombre:</strong> {{ detailMinerData.fullName }}</div>
        <div class="detail-row"><strong>Email:</strong> {{ detailMinerData.email }}</div>
        <div class="detail-row"><strong>RFC:</strong> {{ detailMinerData.rfc }}</div>
        <div class="detail-row"><strong>Teléfono:</strong> {{ detailMinerData.phone }}</div>
        <div class="detail-row"><strong>Dirección:</strong> {{ detailMinerData.address }}</div>
        <div class="detail-row"><strong>Fecha de Nacimiento:</strong> {{ detailMinerData.birthDate | date:'dd/MM/yyyy' }}</div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>
</div> 