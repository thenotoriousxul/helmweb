<div class="helmets-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Gestión de Cascos</h1>
        <p>Monitorea y administra todos los cascos inteligentes</p>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" *ngIf="canCreateHelmet()" (click)="openCreateModal()">
          <i class="fas fa-plus"></i>
          Crear Casco
        </button>
        <button class="btn btn-success" *ngIf="canActivateHelmet()" (click)="openActivateModal()">
          <i class="fas fa-play"></i>
          Activar Casco
        </button>
      </div>
    </div>
  </header>



  <!-- Filters Section -->
  <section class="filters-section">
    <div class="filters-container">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Buscar por número de serie, minero o ubicación..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
      </div>
      
      <div class="filter-options">
        <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option *ngFor="let option of getStatusOptions()" [value]="option.value">
            {{ option.label }}
          </option>
        </select>
        
        <select [(ngModel)]="equipmentFilter" (change)="onEquipmentFilterChange()">
          <option value="all">Todos los equipos</option>
          <option *ngFor="let equipment of getEquipmentTypes()" [value]="equipment">{{ equipment }}</option>
        </select>
        
        <button class="btn btn-secondary">
          <i class="fas fa-filter"></i>
          Filtros Avanzados
        </button>
      </div>
    </div>
  </section>

  <!-- Helmets Grid -->
  <section class="helmets-section">
    <div class="section-header">
      <h2>Lista de Cascos</h2>
      <span class="results-count">{{ filteredHelmets.length }} cascos encontrados</span>
    </div>
    
    <div class="helmets-grid" *ngIf="filteredHelmets.length > 0; else noCascos">
      <div class="helmet-card glass" *ngFor="let helmet of filteredHelmets" [attr.data-status]="helmet.status">
        <div class="card-header">
          <div class="helmet-info">
            <h3>{{ helmet.serialNumber }}</h3>
            <span class="uuid-text">{{ helmet.uuid }}</span>
            <span class="assigned-to" *ngIf="helmet.assignedTo && !authService.isAdmin()">{{ helmet.assignedTo }}</span>
            <span class="not-assigned" *ngIf="!helmet.assignedTo && !authService.isAdmin()">Sin asignar</span>
            <span class="assigned-supervisor" *ngIf="authService.isAdmin() && helmet.supervisorId">
              Supervisor: {{ getSupervisorNameById(helmet.supervisorId) }}
            </span>
          </div>
          <div class="status-badge" [style.background-color]="getStatusColor(helmet.status)">
            {{ getStatusText(helmet.status) }}
          </div>
        </div>
        
        <div class="card-body">
          
          <!-- IDs del Casco -->
          <div class="ids-section">
            <h4 class="section-title">
              <i class="fas fa-id-card"></i>
              Identificadores
            </h4>
            <div class="helmet-details">
              <div class="detail-item">
                <span class="detail-label">ID del Casco:</span>
                <span class="detail-value id-value">{{ helmet.id }}</span>
              </div>
              <div class="detail-item" *ngIf="helmet.physicalId">
                <span class="detail-label">ID Físico:</span>
                <span class="detail-value">{{ helmet.physicalId }}</span>
              </div>
              <div class="detail-item" *ngIf="helmet.supervisorId && !authService.isSupervisor()">
                <span class="detail-label">Supervisor:</span>
                <span class="detail-value">{{ getSupervisorNameById(helmet.supervisorId) }}</span>
              </div>
            </div>
          </div>

          <!-- Información General -->
          <div class="general-info-section">
            <h4 class="section-title">
              <i class="fas fa-info-circle"></i>
              Información General
            </h4>
            <div class="helmet-details">
              <div class="detail-item" *ngIf="helmet.equipmentName">
                <span class="detail-label">Equipo:</span>
                <span class="detail-value">{{ helmet.equipmentName }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Última señal:</span>
                <span class="detail-value">{{ helmet.lastHeartbeat || 'N/A' }}</span>
              </div>
              <div class="detail-item" *ngIf="helmet.createdAt">
                <span class="detail-label">Creado:</span>
                <span class="detail-value">{{ formatDate(helmet.createdAt) }}</span>
              </div>
              <div class="detail-item" *ngIf="helmet.fechaActivacion">
                <span class="detail-label">Activado:</span>
                <span class="detail-value">{{ formatDate(helmet.fechaActivacion) }}</span>
              </div>
            </div>
          </div>

          <!-- IDs de Sensores -->
          <div class="sensor-ids-section" *ngIf="helmet.sensors && helmet.sensors.length > 0">
              <h4 class="section-title">
                <i class="fas fa-microchip"></i>
                Sensores del Casco ({{ helmet.sensors.length }})
                <button 
                  class="toggle-sensors-btn" 
                  (click)="toggleSensors(helmet.id)"
                  [title]="isSensorsExpanded(helmet.id) ? 'Ocultar sensores' : 'Mostrar sensores'"
                >
                  <i class="fas fa-eye" [class.fa-eye]="!isSensorsExpanded(helmet.id)" [class.fa-eye-slash]="isSensorsExpanded(helmet.id)"></i>
                </button>
              </h4>
              <div class="sensor-ids-list" *ngIf="isSensorsExpanded(helmet.id)">
                <div class="sensor-id-item" *ngFor="let sensor of helmet.sensors; let i = index">
                  <div class="sensor-info">
                    <span class="sensor-number">{{ i + 1 }}.</span>
                    <div class="sensor-details">
                      <span class="sensor-name">{{ sensor.name }}</span>
                      <span class="sensor-id-value">ID: {{ sensor.id }}</span>
                      <span class="sensor-unit" *ngIf="sensor.unit">({{ sensor.unit }})</span>
                    </div>
                  </div>
                  <span class="sensor-type-badge" [class]="'type-' + sensor.type">
                    {{ getSensorTypeLabel(sensor.type) }}
                  </span>
                  <span class="sensor-status" [class.active]="sensor.isActive" [class.inactive]="!sensor.isActive">
                    <i class="fas" [class.fa-check-circle]="sensor.isActive" [class.fa-times-circle]="!sensor.isActive"></i>
                    {{ sensor.isActive ? 'Activo' : 'Inactivo' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        
        <div class="card-actions">
          <button class="btn btn-primary" (click)="showDetail(helmet)">
            <i class="fas fa-eye"></i>
            Ver Detalle
          </button>
          
          <button 
            class="btn btn-success" 
            *ngIf="helmet.status === 'inactivo' && canModifyHelmet()"
            (click)="activateHelmet(helmet)"
          >
            <i class="fas fa-play"></i>
            Activar
          </button>
          
          <button 
            class="btn btn-warning" 
            *ngIf="helmet.status === 'activo-sin-asignar' && canModifyHelmet() && !authService.isAdmin()"
            (click)="assignHelmet(helmet)"
          >
            <i class="fas fa-user-plus"></i>
            Asignar
          </button>
          
          <button 
            class="btn btn-info" 
            *ngIf="helmet.status === 'activo-asignado' && canModifyHelmet() && !authService.isAdmin()"
            (click)="unassignHelmet(helmet)"
          >
            <i class="fas fa-user-minus"></i>
            Desasignar
          </button>
          
          <button 
            class="btn btn-secondary" 
            *ngIf="canModifyHelmet()"
            (click)="editHelmet(helmet)"
          >
            <i class="fas fa-edit"></i>
            Editar
          </button>
          
          <button 
            class="btn btn-danger" 
            *ngIf="canModifyHelmet()"
            (click)="deleteHelmet(helmet)"
          >
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </div>
    </div>
    <ng-template #noCascos>
      <div style="padding: 2rem; text-align: center; color: #8892b0;">
        No hay cascos
      </div>
    </ng-template>
  </section>

  <!-- Create Helmet Modal -->
  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Registrar Nuevo Casco</h3>
        <button class="close-btn" (click)="closeCreateModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="createHelmet(createHelmetForm)" #createHelmetForm="ngForm">
          <div class="form-group">
            <label for="serialNumber">Identificador Físico del Casco</label>
            <input 
              type="text" 
              id="serialNumber"
              [(ngModel)]="newHelmet.serialNumber" 
              name="serialNumber"
              #serialCtrl="ngModel"
              placeholder="Ej: HELM-001"
              required minlength="3"
            >
            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }
          </div>

          <div class="form-group" *ngIf="canCreateHelmet()">
            <label for="supervisorSelect">Supervisor asignado</label>
            <select id="supervisorSelect" [(ngModel)]="newHelmet.supervisorId" name="supervisorId">
              <option [ngValue]="undefined">Selecciona un supervisor</option>
              <option *ngFor="let s of supervisorsForCreate" [ngValue]="s.id">{{ s.fullName }}</option>
            </select>
          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fas fa-save"></i>
              Registrar Casco
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Activate Helmet Modal (Supervisor) -->
  <div class="modal-overlay" *ngIf="showActivateModal" (click)="closeActivateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Activar Casco</h3>
        <button class="close-btn" (click)="closeActivateModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="activateNewHelmet(activateHelmetForm)" #activateHelmetForm="ngForm">
          <div class="form-group">
            <label for="serialNumberActivate">Identificador Físico del Casco</label>
            <input 
              type="text" 
              id="serialNumberActivate"
              [(ngModel)]="newHelmet.serialNumber" 
              name="serialNumberActivate"
              #serialActivateCtrl="ngModel"
              placeholder="Ej: HELM-001"
              required minlength="3"
            >
            @if (errorMessage) {
              <div class="error-message">{{ errorMessage }}</div>
            }
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeActivateModal()">Cancelar</button>
            <button type="submit" class="btn btn-success" [disabled]="isLoading">
              <i class="fas fa-play"></i>
              Activar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Helmet Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle del Casco</h3>
        <button class="close-btn" (click)="closeDetailModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="detail-row"><strong>Serial:</strong> {{ detailHelmetData.serialNumber }}</div>
        <div class="detail-row"><strong>UUID:</strong> {{ detailHelmetData.uuid }}</div>
        <div class="detail-row"><strong>Estado:</strong> {{ getStatusText(detailHelmetData.status || 'inactivo') }}</div>
        <div class="detail-row"><strong>Asignado a:</strong> {{ detailHelmetData.assignedTo || 'Sin asignar' }}</div>
        <div class="detail-row" *ngIf="detailHelmetData.assignedToEmail"><strong>Email del minero:</strong> {{ detailHelmetData.assignedToEmail }}</div>
        <div class="detail-row" *ngIf="detailHelmetData.assignedToId"><strong>ID del minero:</strong> {{ detailHelmetData.assignedToId }}</div>
        <div class="detail-row"><strong>Supervisor:</strong> {{ detailHelmetData.supervisorName || detailHelmetData.supervisorId }}</div>
        <div class="detail-row"><strong>Última señal:</strong> {{ detailHelmetData.lastHeartbeat }}</div>
        <div class="detail-row"><strong>Temperatura:</strong> {{ detailHelmetData.temperature || 0 }}°C</div>
        <!-- Se eliminan Batería y Ubicación por no formar parte de los sensores activos -->


        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Helmet Modal -->
  <div class="modal-overlay" *ngIf="showAssignModal" (click)="closeAssignModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Asignar Casco</h3>
        <button class="close-btn" (click)="closeAssignModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="search-box" style="margin-bottom: 1rem;">
          <i class="fas fa-search"></i>
          <input 
            type="text" 
            placeholder="Buscar minero por nombre, correo, RFC o teléfono..."
            [(ngModel)]="assignSearchTerm"
            (input)="onAssignSearchChange()"
          >
        </div>

        <div class="miners-grid assign-scroll" *ngIf="filteredMinersForAssign.length > 0; else noMinersAssign">
          <div class="miner-card glass" *ngFor="let miner of filteredMinersForAssign">
            <div class="card-header">
              <div class="miner-info">
                <div class="miner-avatar">
                  <ng-container *ngIf="miner.photo; else initialsAvatar">
                    <img [src]="miner.photo" [alt]="miner.fullName || miner.email" />
                  </ng-container>
                  <ng-template #initialsAvatar>
                    <span>{{ (miner.fullName || miner.email || 'M').charAt(0) | uppercase }}</span>
                  </ng-template>
                </div>
                <div class="miner-details">
                  <h3>{{ miner.fullName }}</h3>
                  <div class="miner-email">Email: {{ miner.email }}</div>
                  <div class="miner-rfc">RFC: {{ miner.rfc || 'No especificado' }}</div>
                </div>
              </div>
              <!-- Se elimina visualización de estado -->
            </div>
            <div class="card-body">
              <div class="miner-details-grid">
                <div class="detail-item">
                  <span class="detail-label">Teléfono:</span>
                  <span class="detail-value">{{ miner.phone || 'No especificado' }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Fecha Nacimiento:</span>
                  <span class="detail-value">{{ miner.birthDate ? (miner.birthDate | date:'dd/MM/yyyy') : 'No especificada' }}</span>
                </div>
              </div>
            </div>
            <div class="card-actions">
              <button class="btn btn-primary" (click)="doAssignMiner(miner)">
                <i class="fas fa-user-check"></i>
                Asignar a este minero
              </button>
            </div>
          </div>
        </div>
        <ng-template #noMinersAssign>
          <div style="padding: 2rem; text-align: center; color: #8892b0;">No hay mineros</div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- Edit Helmet Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Casco</h3>
        <button class="close-btn" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="saveEditHelmet(editHelmetForm)" #editHelmetForm="ngForm">
          <div class="form-group">
            <label for="editSerialNumber">Serial</label>
            <input type="text" id="editSerialNumber" [(ngModel)]="editHelmetData.serialNumber" name="editSerialNumber" #editSerialCtrl="ngModel" required minlength="3">
            @if ((editHelmetForm.submitted || editSerialCtrl.touched || editSerialCtrl.dirty) && editSerialCtrl.errors?.['required']) {
              <div class="error-message">El serial es obligatorio</div>
            }
            @if ((editHelmetForm.submitted || editSerialCtrl.touched || editSerialCtrl.dirty) && editSerialCtrl.errors?.['minlength']) {
              <div class="error-message">El serial debe tener al menos 3 caracteres</div>
            }
          </div>
          <div class="form-group">
            <label for="editUuid">UUID</label>
            <input type="text" id="editUuid" [(ngModel)]="editHelmetData.uuid" name="editUuid" #editUuidCtrl="ngModel" required>
            @if ((editHelmetForm.submitted || editUuidCtrl.touched || editUuidCtrl.dirty) && editUuidCtrl.errors?.['required']) {
              <div class="error-message">El UUID es obligatorio</div>
            }
          </div>
          <div class="form-group">
            <label for="editStatus">Estado</label>
            <select id="editStatus" [(ngModel)]="editHelmetData.status" name="editStatus" #editStatusCtrl="ngModel" required>
              <option value="inactivo">Inactivo</option>
              <option value="activo">Activo</option>
              <option value="activo-sin-asignar">Activo Sin Asignar</option>
              <option value="activo-asignado">Activo Asignado</option>
            </select>
            @if ((editHelmetForm.submitted || editStatusCtrl.touched || editStatusCtrl.dirty) && editStatusCtrl.errors?.['required']) {
              <div class="error-message">El estado es obligatorio</div>
            }
          </div>

          @if (editFormError) {
            <div class="error-message">{{ editFormError }}</div>
          }

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="isLoading">
              <i class="fas fa-save"></i>
              Guardar Cambios
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Helmet Modal -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Eliminar Casco</h3>
        <button class="close-btn" (click)="closeDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que quieres eliminar el casco <strong>{{ helmetToDelete?.serialNumber }}</strong>?</p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
          <button type="button" class="btn btn-danger" (click)="confirmDeleteHelmet()">
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>
</div> 