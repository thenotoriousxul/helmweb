<div class="equipments-container">
  <!-- Header -->
  <header class="page-header">
    <div class="header-content">
      <div class="header-left">
        <h1>Gestión de Equipos</h1>
        <p>Administra los equipos de minería y sus configuraciones</p>
      </div>
      <div class="header-right">
        <button class="btn btn-primary" (click)="openCreateModal()" *ngIf="canCreateTeam()">
          <i class="fas fa-plus"></i>
          Nuevo Equipo
        </button>
      </div>
    </div>
  </header>

  <!-- Filters -->
  <section class="filters-section">
    <div class="filters-container glass">
      <div class="search-box">
        <i class="fas fa-search"></i>
        <input 
          type="text" 
          placeholder="Buscar equipos..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange()"
        >
      </div>
      
      <div class="filter-controls">
        <select [(ngModel)]="statusFilter" (change)="onStatusFilterChange()">
          <option value="all">Todos los Estados</option>
          <option value="active">Activo</option>
          <option value="warning">Advertencia</option>
          <option value="inactive">Inactivo</option>
        </select>
        
        <select [(ngModel)]="zoneFilter" (change)="onZoneFilterChange()">
          <option value="all">Todas las Zonas</option>
          <option *ngFor="let zone of getZones()" [value]="zone">
            {{ zone }}
          </option>
        </select>
      </div>
    </div>
  </section>



  <!-- Equipment Table -->
  <section class="equipment-table-section">
    <div class="table-container glass">
      <div class="table-header">
        <h2>Lista de Equipos</h2>
        <span class="results-count">{{ filteredTeams.length }} equipos encontrados</span>
      </div>
      
      <!-- Desktop Table View -->
      <div class="table-responsive" *ngIf="filteredTeams.length > 0">
        <table class="equipment-table">
          <thead>
            <tr>
              <th>Equipo</th>
              <th>Zona</th>
              <th>Supervisor</th>
              <th>Estado</th>
              <th>Mineros</th>
              <th>Fecha Creación</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let team of filteredTeams" class="equipment-row">
              <td class="equipment-name">
                <div class="name-cell">
                  <h4>{{ team.nombre }}</h4>
                  <span class="equipment-id">ID: {{ team.id }}</span>
                </div>
              </td>
              <td>
                <span class="zone-badge">{{ team.zona }}</span>
              </td>
              <td>
                <span class="supervisor-name">
                  <i class="fas fa-user-tie"></i>
                  {{ team.supervisor?.fullName || 'Sin asignar' }}
                </span>
              </td>
              <td>
                <span class="status-badge" [style.background-color]="getStatusColor(getTeamStatus(team))">
                  {{ getStatusText(getTeamStatus(team)) }}
                </span>
              </td>
              <td>
                <div class="miners-info">
                  <span class="miners-count">{{ team.mineros?.length || 0 }}/10</span>
                  <div class="miners-bar">
                    <div class="miners-progress" 
                         [style.width]="((team.mineros?.length || 0) / 10 * 100) + '%'">
                    </div>
                  </div>
                </div>
              </td>
              <td>{{ team.createdAt | date:'short' }}</td>
              <td class="actions">
                <div class="action-buttons">
                  <button class="btn-icon" (click)="showDetail(team)" title="Ver detalle">
                    <i class="fas fa-eye"></i>
                  </button>
                  <button class="btn-icon" (click)="editTeam(team)" title="Editar" *ngIf="canModifyTeam()">
                    <i class="fas fa-edit"></i>
                  </button>
                  <button class="btn-icon" (click)="openAssignMinerModal(team)" title="Asignar minero" *ngIf="canModifyTeam()">
                    <i class="fas fa-user-plus"></i>
                  </button>
                  <button class="btn-icon" title="Desasignar minero" *ngIf="canModifyTeam() && (team.mineros?.length || 0) > 0" (click)="openRemoveMinerModal(team)">
                    <i class="fas fa-user-minus"></i>
                  </button>
                  <button class="btn-icon danger" (click)="deleteTeam(team)" title="Eliminar" *ngIf="canModifyTeam()">
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Mobile Card View -->
      <div class="equipment-cards" *ngIf="filteredTeams.length > 0">
        <div class="equipment-card-mobile" *ngFor="let team of filteredTeams">
          <div class="equipment-card-header">
            <div class="equipment-card-title">
              <h3>{{ team.nombre }}</h3>
              <span class="equipment-id">ID: {{ team.id }}</span>
            </div>
            <span class="status-badge" [style.background-color]="getStatusColor(getTeamStatus(team))">
              {{ getStatusText(getTeamStatus(team)) }}
            </span>
          </div>
          
          <div class="equipment-card-details">
            <div class="equipment-detail-item">
              <span class="equipment-detail-label">Zona</span>
              <span class="equipment-detail-value zone-badge">{{ team.zona }}</span>
            </div>
            <div class="equipment-detail-item">
              <span class="equipment-detail-label">Mineros</span>
              <span class="equipment-detail-value">{{ team.mineros?.length || 0 }}/10</span>
            </div>
            <div class="equipment-detail-item">
              <span class="equipment-detail-label">Supervisor</span>
              <span class="equipment-detail-value">{{ team.supervisor?.fullName || 'Sin asignar' }}</span>
            </div>
            <div class="equipment-detail-item">
              <span class="equipment-detail-label">Fecha Creación</span>
              <span class="equipment-detail-value">{{ team.createdAt | date:'short' }}</span>
            </div>
          </div>
          
          <div class="equipment-card-actions">
            <button class="btn-icon" (click)="showDetail(team)" title="Ver detalle">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-icon" (click)="editTeam(team)" title="Editar" *ngIf="canModifyTeam()">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-icon" (click)="openAssignMinerModal(team)" title="Asignar minero" *ngIf="canModifyTeam()">
              <i class="fas fa-user-plus"></i>
            </button>
            <button class="btn-icon" title="Desasignar minero" *ngIf="canModifyTeam() && (team.mineros?.length || 0) > 0" (click)="openRemoveMinerModal(team)">
              <i class="fas fa-user-minus"></i>
            </button>
            <button class="btn-icon danger" (click)="deleteTeam(team)" title="Eliminar" *ngIf="canModifyTeam()">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      </div>
      <div *ngIf="filteredTeams.length === 0" style="padding: 2rem; text-align: center; color: #8892b0;">
        No hay equipos
      </div>
    </div>
  </section>

  <div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Crear Nuevo Equipo</h3>
        <button class="close-btn" (click)="closeCreateModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="modal-body">
        <form (ngSubmit)="createTeam(createTeamForm)" #createTeamForm="ngForm">
          <div class="form-group">
            <label for="nombre">Nombre del Equipo</label>
            <input 
              type="text" 
              id="nombre"
              [(ngModel)]="newTeam.nombre" 
              name="nombre"
              #nombreCtrl="ngModel"
              placeholder="Ej: Equipo Mina Norte"
              required
            >
            @if ((createTeamForm.submitted || nombreCtrl.touched || nombreCtrl.dirty) && nombreCtrl.errors?.['required']) {
              <div class="error-message">El nombre es obligatorio</div>
            }
          </div>
          
          <div class="form-group">
            <label for="zona">Zona</label>
            <input 
              type="text" 
              id="zona"
              [(ngModel)]="newTeam.zona" 
              name="zona"
              #zonaCtrl="ngModel"
              placeholder="Ej: Zona A-12"
              required
            >
            @if ((createTeamForm.submitted || zonaCtrl.touched || zonaCtrl.dirty) && zonaCtrl.errors?.['required']) {
              <div class="error-message">La zona es obligatoria</div>
            }

          </div>
          
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeCreateModal()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              <i class="fas fa-plus"></i>
              Crear Equipo
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Detail Team Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal" (click)="closeDetailModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Detalle del Equipo</h3>
        <button class="close-btn" (click)="closeDetailModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
          <div class="modal-body">
          <div class="detail-row"><strong>Nombre:</strong> {{ detailTeamData.nombre }}</div>
          <div class="detail-row"><strong>Zona:</strong> {{ detailTeamData.zona }}</div>
          <div class="detail-row"><strong>Supervisor:</strong> {{ detailTeamData.supervisor?.fullName || 'Sin asignar' }}</div>
          <div class="detail-row"><strong>Mineros:</strong> {{ detailTeamData.mineros?.length || 0 }}</div>
          <div class="detail-row"><strong>Fecha de creación:</strong> {{ detailTeamData.createdAt | date:'short' }}</div>

          <div class="miners-list" *ngIf="detailTeamData.mineros?.length; else noTeamMiners">
            <div class="miner-item" *ngFor="let tm of detailTeamData.mineros">
              <div class="miner-avatar"><span>{{ (tm.minero?.fullName || tm.minero?.email || 'M').charAt(0) | uppercase }}</span></div>
              <div class="miner-meta">
                <div class="miner-name">{{ tm.minero?.fullName || 'Sin nombre' }}</div>
                <div class="miner-email" *ngIf="tm.minero?.email">{{ tm.minero?.email }}</div>
                <div class="miner-extra">
                  <span *ngIf="tm.minero?.rfc">RFC: {{ tm.minero?.rfc }}</span>
                  <span *ngIf="tm.minero?.phone"> · Tel: {{ tm.minero?.phone }}</span>
                  <span *ngIf="tm.fechaAsignacion"> · Asignado: {{ tm.fechaAsignacion | date:'short' }}</span>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noTeamMiners>
            <div style="padding: .5rem 0; color: #8892b0;">No hay mineros asignados</div>
          </ng-template>

          <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDetailModal()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Team Modal -->
  <div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar Equipo</h3>
        <button class="close-btn" (click)="closeEditModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="saveEditTeam(editTeamForm)" #editTeamForm="ngForm">
          
          <div class="form-group">
            <label for="editNombre">Nombre</label>
            <input type="text" id="editNombre" [(ngModel)]="editTeamData.nombre" name="editNombre" #editNombreCtrl="ngModel" required>
            @if ((editTeamForm.submitted || editNombreCtrl.touched || editNombreCtrl.dirty) && editNombreCtrl.errors?.['required']) {
              <div class="error-message">El nombre es obligatorio</div>
            }
          </div>
          <div class="form-group">
            <label for="editZona">Zona</label>
            <input type="text" id="editZona" [(ngModel)]="editTeamData.zona" name="editZona" #editZonaCtrl="ngModel" required>
            @if ((editTeamForm.submitted || editZonaCtrl.touched || editZonaCtrl.dirty) && editZonaCtrl.errors?.['required']) {
              <div class="error-message">La zona es obligatoria</div>
            }
          </div>
          @if (editFormError) {
            <div class="error-message">{{ editFormError }}</div>
          }
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeEditModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="loading">
              <i class="fas fa-save"></i>
              Guardar Cambios
            </button>
            
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Team Modal -->
  <div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeDeleteModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Eliminar Equipo</h3>
        <button class="close-btn" (click)="closeDeleteModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que quieres eliminar el equipo <strong>{{ teamToDelete?.nombre }}</strong>?</p>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" (click)="closeDeleteModal()">Cancelar</button>
          <button type="button" class="btn btn-danger" (click)="confirmDeleteTeam()">
            <i class="fas fa-trash"></i>
            Eliminar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Assign Miner Modal -->
  <div class="modal-overlay" *ngIf="showAssignMinerModal" (click)="closeAssignMinerModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Asignar Minero a Equipo</h3>
        <button class="close-btn" (click)="closeAssignMinerModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="assignMinerToTeam()">
          <div class="form-group">
            <label for="selectMiner">Selecciona un minero</label>
            <select id="selectMiner" [(ngModel)]="selectedMinerId" name="selectMiner" required>
              <option value="" disabled selected>Selecciona un minero</option>
              <option *ngFor="let miner of availableMiners" [value]="miner.id">
                {{ miner.fullName }} ({{ miner.email }})
              </option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeAssignMinerModal()">Cancelar</button>
            <button type="submit" class="btn btn-primary" [disabled]="!selectedMinerId || isAssigning">
              <i class="fas fa-user-plus"></i>
              Asignar Minero
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Remove Miner Modal -->
  <div class="modal-overlay" *ngIf="showRemoveMinerModal" (click)="closeRemoveMinerModal()">
    <div class="modal-content glass" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Desasignar Minero del Equipo</h3>
        <button class="close-btn" (click)="closeRemoveMinerModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="modal-body">
        <form (ngSubmit)="removeMinerFromTeamConfirm()">
          <div class="form-group">
            <label for="selectMinerRemove">Selecciona un minero</label>
            <select id="selectMinerRemove" [(ngModel)]="selectedMinerToRemoveId" name="selectMinerRemove" required>
              <option value="" disabled selected>Selecciona un minero</option>
              <option *ngFor="let miner of currentMinersForRemove" [value]="miner.id">
                {{ miner.fullName }} ({{ miner.email }})
              </option>
            </select>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeRemoveMinerModal()">Cancelar</button>
            <button type="submit" class="btn btn-danger" [disabled]="!selectedMinerToRemoveId">
              <i class="fas fa-user-minus"></i>
              Desasignar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div> 